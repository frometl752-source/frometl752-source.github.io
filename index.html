<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨æƒ…åŒ…ç½‘æ ¼åˆ‡å›¾å·¥å…· (6x4)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }
        h1 { margin-bottom: 1.5rem; color: #1f2937; }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn:hover { background-color: #4338ca; }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-upload { background-color: #059669; }
        
        /* é¢„è§ˆåŒºåŸŸ */
        #preview-container {
            position: relative;
            margin: 20px auto;
            max-width: 100%;
            overflow: hidden;
            border: 2px dashed #d1d5db;
            display: none; /* åˆå§‹éšè— */
        }
        
        #preview-img {
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* ç½‘æ ¼é®ç½© */
        #grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* ç»“æœåŒºåŸŸ */
        .result-area {
            margin-top: 20px;
            display: none;
        }
        .status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #6b7280;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>âœ‚ï¸ è¡¨æƒ…åŒ…ç½‘æ ¼åˆ‡åˆ†å·¥å…·</h1>
        
        <div class="controls">
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">ğŸ“ ä¸Šä¼ å›¾ç‰‡</button>
            
            <div class="input-group">
                <label>æ¨ªå‘(åˆ—):</label>
                <input type="number" id="colInput" value="6" min="1">
            </div>
            <div class="input-group">
                <label>çºµå‘(è¡Œ):</label>
                <input type="number" id="rowInput" value="4" min="1">
            </div>

            <button class="btn" id="previewBtn" disabled>åˆ·æ–°é¢„è§ˆç½‘æ ¼</button>
        </div>

        <div id="preview-container">
            <img id="preview-img" alt="Source Image">
            <canvas id="grid-overlay"></canvas>
        </div>

        <div class="result-area" id="resultArea">
            <button class="btn" id="downloadBtn">ğŸ“¦ ç”Ÿæˆå¹¶ä¸‹è½½ ZIP</button>
            <p class="status" id="statusText"></p>
        </div>
    </div>

    <canvas id="processCanvas" style="display: none;"></canvas>

    <script>
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-img');
        const gridOverlay = document.getElementById('grid-overlay');
        const colInput = document.getElementById('colInput');
        const rowInput = document.getElementById('rowInput');
        const previewBtn = document.getElementById('previewBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resultArea = document.getElementById('resultArea');
        const statusText = document.getElementById('statusText');
        const processCanvas = document.getElementById('processCanvas');

        let originalImage = new Image();
        let isImageLoaded = false;

        // 1. ç›‘å¬æ–‡ä»¶ä¸Šä¼ 
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                originalImage = new Image();
                originalImage.onload = () => {
                    isImageLoaded = true;
                    previewImg.src = originalImage.src;
                    previewContainer.style.display = 'block';
                    previewBtn.disabled = false;
                    resultArea.style.display = 'block';
                    drawGrid(); // å›¾ç‰‡åŠ è½½å®Œç«‹å³ç”»ç½‘æ ¼
                };
                originalImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // 2. åˆ·æ–°ç½‘æ ¼é¢„è§ˆ
        previewBtn.addEventListener('click', drawGrid);
        
        // å½“è¾“å…¥æ¡†æ”¹å˜æ—¶è‡ªåŠ¨åˆ·æ–°ç½‘æ ¼
        colInput.addEventListener('input', drawGrid);
        rowInput.addEventListener('input', drawGrid);

        // ç»˜åˆ¶çº¢è‰²å‚è€ƒçº¿
        function drawGrid() {
            if (!isImageLoaded) return;

            // è®¾ç½®Overlay Canvasçš„å¤§å°ä¸æ˜¾ç¤ºçš„å›¾ç‰‡å¤§å°ä¸€è‡´ï¼ˆæ³¨æ„æ˜¯CSSæ¸²æŸ“å¤§å°ï¼Œä¸æ˜¯åŸå§‹åƒç´ å¤§å°ï¼‰
            // è¿™é‡Œæˆ‘ä»¬éœ€è¦è·å–å›¾ç‰‡åœ¨é¡µé¢ä¸Šçš„å®é™…æ˜¾ç¤ºå°ºå¯¸
            const rect = previewImg.getBoundingClientRect();
            gridOverlay.width = rect.width;
            gridOverlay.height = rect.height;

            const ctx = gridOverlay.getContext('2d');
            const cols = parseInt(colInput.value);
            const rows = parseInt(rowInput.value);

            ctx.clearRect(0, 0, gridOverlay.width, gridOverlay.height);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const cellW = gridOverlay.width / cols;
            const cellH = gridOverlay.height / rows;

            // ç”»å‚ç›´çº¿
            for (let i = 1; i < cols; i++) {
                ctx.moveTo(i * cellW, 0);
                ctx.lineTo(i * cellW, gridOverlay.height);
            }
            // ç”»æ°´å¹³çº¿
            for (let j = 1; j < rows; j++) {
                ctx.moveTo(0, j * cellH);
                ctx.lineTo(gridOverlay.width, j * cellH);
            }
            ctx.stroke();
        }

        // 3. æ‰§è¡Œåˆ‡å›¾å¹¶æ‰“åŒ…ä¸‹è½½
        downloadBtn.addEventListener('click', async () => {
            if (!isImageLoaded) return;

            statusText.innerText = "æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...";
            downloadBtn.disabled = true;

            const cols = parseInt(colInput.value);
            const rows = parseInt(rowInput.value);
            const ctx = processCanvas.getContext('2d');
            const zip = new JSZip();
            const folder = zip.folder("emojis");

            // è®¡ç®—å•ä¸ªåˆ‡ç‰‡çš„åŸå§‹å°ºå¯¸
            const sliceWidth = originalImage.width / cols;
            const sliceHeight = originalImage.height / rows;

            // è°ƒæ•´å¤„ç†Canvasçš„å¤§å°ä¸ºå•ä¸ªåˆ‡ç‰‡çš„å¤§å°
            processCanvas.width = sliceWidth;
            processCanvas.height = sliceHeight;

            let count = 0;

            // å¾ªç¯åˆ‡å›¾
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    // æ¸…ç©ºç”»å¸ƒ
                    ctx.clearRect(0, 0, sliceWidth, sliceHeight);
                    
                    // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
                    ctx.drawImage(
                        originalImage, 
                        c * sliceWidth, r * sliceHeight, sliceWidth, sliceHeight, // è£å‰ªæºä½ç½®
                        0, 0, sliceWidth, sliceHeight // æ”¾ç½®ç›®æ ‡ä½ç½®
                    );

                    // è½¬æ¢ç”±äºCanvasä¸ºBlob
                    const blob = await new Promise(resolve => processCanvas.toBlob(resolve, 'image/png'));
                    
                    // æ ¼å¼åŒ–æ–‡ä»¶åï¼šemoji_01.png, emoji_02.png...
                    count++;
                    const fileName = `emoji_${count.toString().padStart(2, '0')}.png`;
                    folder.file(fileName, blob);
                }
            }

            // ç”ŸæˆZipå¹¶è§¦å‘ä¸‹è½½
            statusText.innerText = "æ­£åœ¨æ‰“åŒ…...";
            zip.generateAsync({type:"blob"})
            .then(function(content) {
                saveAs(content, "emojis_pack.zip");
                statusText.innerText = `âœ… å®Œæˆï¼å·²ä¸‹è½½ ${count} å¼ å›¾ç‰‡ã€‚`;
                downloadBtn.disabled = false;
            });
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜ç½‘æ ¼ä»¥ä¿æŒå¯¹é½
        window.addEventListener('resize', () => {
             if(isImageLoaded) setTimeout(drawGrid, 100);
        });

    </script>
</body>
</html>
